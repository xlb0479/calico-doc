# 网络策略

> 这里包含了一些相关的背景知识，不仅限于Calico。

K8S和Calico提供网络策略API，让你加固你的应用。

在本文中你会学习到：

- 什么是网络策略及其重要性。
- K8S和Calico的网络策略差异以及你应该如何选择。
- 网络策略最佳实践。

## 什么是网络策略

网络策略是用来加固K8S网络的主要工具。它可以让你轻松限制集群内的网络流量，只存在那些被你允许的网络流量。

要了解网络策略的重要性，让我们先快速学习一下在没有网络策略之前是如何实现网络安全的。放眼过去，在企业网络中，网络安全都是要通过设计网络设备的拓扑结构（交换机、路由器、防火墙），对它们进行相关配置来实现。物理拓扑定义了网络的安全边界。在虚拟化的萌芽时代，同样的网络和网络设备在云端实现了虚拟化，使用同样的技术来创建特定的（虚拟）网络设备的网络拓扑，从而实现网络安全。每当增加新的应用或服务时，通常需要同时进行网络设计，更新网络拓扑和网络设备配置，提供期望的安全能力。

相反，[K8S网络模型](03K8S网络.md)定义了一个“扁平”网络，其中的所有Pod都可以通过Pod的IP地址来相互访问。这种方式极大简化了网络设计工作，允许工作负载在集群中进行动态调度，无需依赖网络设计。

在这种模式下，网络安全并不通过网络拓扑边界来定义，而是要使用独立于网络拓扑的网络策略来定义。网络策略是对网络的进一步抽象，它使用标签选择器作为主要的实现机制，定义哪些工作负载可以相互通信，而不是哪些IP地址或IP地址范围。

## 网络策略的重要性

现在的攻击者也越来越牛逼了，网络安全防线也提升到了前所未有的高度。

虽然可以（并且应当）用防火墙来限制住你的网络周边的流量（一般也叫南北流量），但使用这些能力来管理K8S的流量的话，通常都是将集群作为一个整体粒度来进行管理，而不是细化到特定的Pod组，而且还要伴随着Pod的动态调度和动态IP的特性。此外，对于大部分的攻击者来说，一旦它们在边界内拿到了一个微小的落脚点，然后就要开始尝试去访问（通常叫东西流量）更高价值的目标，此时再靠防火墙就挡不住了。

另一方面，网络策略为K8S的动态本质而设计，遵循标准的K8S范式，使用标签选择器来定义Pod组，而不是IP地址。而且由于网络策略是在集群内的强制行为，因此它可以用于同时监管南北和东西流量。

网络策略代表着网络安全的一次重大革新，不光是因为它能够处理现代微服务的动态本质，而且它还能让开发工程师和DevOps工程师们更方便的自定义网络安全，无需了解过多的底层网络细节，或者跑去给负责防火墙的团队提要求。网络策略可以轻松定义出你的意图，比如“只允许这个微服务访问这个数据库”，将你的意图携程代码（一般是YAML文件），然后跟网络策略审计一起整合到Git工作流和CI/CD过程中。

> 注意：Calico和Calico企业版可以让防火墙跟K8S集成的更加紧密。但是，这并不是说在集群内就不需要网络策略了。

## K8S的网络策略

K8S的网络策略要用K8S的[NetworkPolicy](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#networkpolicy-v1-networking-k8s-io)资源来定义。

K8S网络策略的主要特点如下：

- 策略是基于命名空间的（比如可以在指定命名空间的上下文中进行创建，就跟Pod似的）
- 策略用标签选择器施加给Pod
- 策略规则可以定义出对于其他Pod、命名空间、CIDR允许的出入流量
- 策略规则可以指定协议（TCP、UDP、SCTP）、命名端口或端口号

K8S本身并不强加网络策略，而是把权力交给了网络插件。大部分插件都实现了K8S网络策略中的主流元素，但并没有实现规范中的全部特性。（Calico确实实现了所有特性，而且是K8S网络策略的原始参考实现。）

如果你想学习K8S的网络策略，详见[K8S网络策略入门](../04安全/03策略入门/02K8S策略/01K8S网络策略入门.md)。

## Calico网络策略

除了施行K8S的网络策略，Calico也有自己的基于命名空间的[NetworkPolicy](../06参考/04资源定义/12网络策略.md)和无命名空间的[GlobalNetworkPolicy](../06参考/04资源定义/06全局网络策略.md)资源，它们可以提供K8S网络策略无法提供的额外特性。其中包括：

- 策略排序/优先级
- 在规则中拒绝和记录动作
- 应用策略时，以及在策略规则中，提供更加灵活的匹配方式，包括对K8S的ServiceAccount的匹配，以及（如果上了Istio和Envoy）加密身份匹配，以及5-7层的匹配方法，比如HTTP和gRPC的URL。
- 在策略中可以引用非K8S工作负载，比如在策略规则中匹配[NetworkSet](../06参考/04资源定义/13网络集.md)

K8S的网络策略只能应用于Pod，Calico的网络策略则可以应用到多个点上，包括Pod、VM、主机接口。

关于Calico网络策略，详见[Calico网络策略入门](../04安全/03策略入门/01Calico策略/01Calico网络策略入门.md)

## 使用Calico网络策略的好处

### 完全支持K8S的网络策略

不同于其他的网络策略实现，Calico实现了完整的K8S网络策略特性。

### 更丰富的网络策略

如果你需要的话，Calico的网络策略可以比K8S网络策略实现更丰富的流量控制。而且Calico还允许你通过GlobalNetworkPolicy资源创建跨多个命名空间的策略。

### 混合K8S和Calico网络策略

K8S和Calico的网络策略可以无缝融合。一个常见的场景是用来区分安全/集群运维团队和开发者/服务团队间的职责。比如，给安全/集群运维团队的RBAC权限是定义Calico策略，而开发者/服务团队的RBAC权限是在他们自己的命名空间中定义K8S的网络策略。因为Calico的策略规则可以排到K8S网络策略之前或之后施行，并且还可以包含拒绝动作和日志记录动作，这样就可以让安全/集群运维团队定义基础的、高层次的、广泛适用的规则，然后让开发者/服务团队在他们自己负责的应用和服务上定义细粒度的约束。

为了更灵活的控制和委派两个或更多团队间的职责，Calico企业版扩展了这种模型，提供[层次化策略](#层次化策略)。

![img](https://projectcalico.docs.tigera.io/images/example-k8s-calico-policy-mix.svg)

### 可以保护主机和VM

因为Calico的策略可以施加于主机接口上，你可以用它们来保护你的K8S节点（不光是你的Pod了），包括例如限制节点端口的集群外访问。详见Calico[主机策略](../04安全/05主机策略/00主机策略.md)。

### Istio集成

如果你上了Istio服务网格，Calico策略引擎可以在主机网络层和服务网格层施加相同的策略模型，保护你的基础设置免受脆弱的工作负载的干扰，反过来也可以保护你的工作负载免受脆弱的基础设施的干扰。（哎，哪儿哪儿都那么脆弱。）这样还可以避免在服务网格和基础设施层搞出两套安全方案，在不同的层次上要学习不同的策略模型。

### 可扩展到Calico企业版

Calico企业版添加了更加丰富的网络策略能力，可以定义层次化策略，每个团队具有特定的信任边界，可以在策略规则中用FQDN/域名来限制对指定外部服务的访问。

## 网络策略最佳实践

### Ingress和Egress

最基本的吧，我们建议每个Pod都应该通过网络策略ingress规则保护起来，限制什么样的连接可以连到它，可以连到它的哪个端口上。最佳实践还要求定义网络策略egress，Pod向外发起的连接只能是它们真正需要的连接。Ingress规则可以保护Pod免受Pod来自外部的攻击。Egress规则保护Pod以外的其它玩意儿，避免在Pod沦陷后受到波及，减少后续的攻击面（东西方向），或者是阻止攻击者将数据泄漏到集群外部（南北方向）。

### 策略模式

因为网络策略的灵活性及标签化，通常可以使用多种挂标签和策略编写方法来实现同样的目的。最常见的方法就是搞几个全局的策略然后施加给所有的Pod，然后再为单个Pod定义它的ingress和egress规则。

比如：

```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: front-end
  namespace: staging
spec:
  podSelector:
    matchLabels:
      app: back-end
  ingress:
    - from:
      - podSelector:
          matchLabels:
            app: front-end
    ports:
    - protocol: TCP
      port: 443
  egress:
    - to:
      - podSelector:
          matchLabels:
            app: database
    ports:
    - protocol: TCP
      port: 27017
```

### 默认拒绝

一种施行最佳实践的方法是定义[默认拒绝](../04安全/03策略入门/03开启默认拒绝.md)的网络策略。这样就可以确保如果不去定义明确的Pod流量出入策略，所有的流量都会被拒绝。这样的结果就是，任何团队创建一个新的Pod后，强制他们去定义该Pod的网络策略。可以用Calico的GlobalNetworkPolicy来实现这个目的（而不是每次新建一个命名空间的时候都要定义一个策略），然后在默认拒绝中包含一些例外条件（比如允许Pod访问DNS）。

比如，你可以用下面的策略来默认拒绝所有的（非系统的）Pod的流量，除了对kube-dns/core-dns发起的DNS查询。

```yaml
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: default-app-policy
spec:
  namespaceSelector: has(projectcalico.org/name) && projectcalico.org/name not in {"kube-system", "calico-system"}
  types:
  - Ingress
  - Egress
  egress:
    - action: Allow
      protocol: UDP
      destination:
        selector: k8s-app == "kube-dns"
        ports:
        - 53
```

### 层次化策略

[Calico企业版](https://docs.tigera.io/v3.11/security/tiered-policy)使用策略分层来支持层次化网络策略。可以定义每一层的RBAC，限制谁可以使用哪一层。这样可以在多个团队中委派信任。

![img](https://projectcalico.docs.tigera.io/images/example-tiers.svg)