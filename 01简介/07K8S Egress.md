# K8S Egress

> 这里包含了一些相关的背景知识，不仅限于Calico。

在这里你会了解到：

- 什么是K8S的Egress？
- 为什么要限制出口流量，如何做到？
- 什么是“NAT outgoing”，什么时候用到？
- 什么是egress网关，为什么要用它？

## 什么是K8S的Egress？

这里我们用K8S的Egress来描述那些从Pod向集群外任意一点发起的连接。

与入口流量不同，K8S有[Ingress](06K8S%20Ingress.md)资源来管理入口流量，但是并没有K8S Egress资源。出口流量在处理的时候是根据集群使用的K8S网络实现/CNI插件，在网络层面进行处理的，如果用了服务网格，那么就是在这些网络实现之上添加出口行为。

关于出口流量有这么三大块需要了解的地方，所以你可以根据自己的需要来选择网络和/或服务网格：

- 限制出口流量
- Outgoing NAT行为
- 出口网关

## 限制出口流量

常见的安全需求和最佳实践就是要限制从集群内向外发出的连接。通常是使用[网络策略](04网络策略.md)为每个微服务定义出口规则来实现这一点，而且通常是搞一个[默认拒绝](04网络策略.md#默认拒绝)的策略，保证所有的外出连接默认都是被拒绝的，直到增加明确的允许外出流量的策略。

用K8S的网络策略来限制对特定外部资源的访问时，存在的一个问题是，外部资源需要用IP地址来标识（或者IP地址范围）。如果资源关联的IP变了，那么所有引用这个IP的策略都要更新。这个问题可以用Calico[网络集](../04%E5%AE%89%E5%85%A8/04策略规则/05外部IP或网络规则.md)来规避，或者是Calico企业版，支持在策略规则中用[域名](../04%E5%AE%89%E5%85%A8/11Calico企业版/02高级出口访问控制.md)。

除了网络策略，服务网格通常也可以让你配置Pod可以访问的外部服务。比如用Istio的时候，可以集成Calico在服务网格层施行网络策略，包括[L5-7规则](../04%E5%AE%89%E5%85%A8/07Istio的策略/02在策略规则中使用HTTP方法与路径.md)，作为在规则中无需使用IP地址的方案。关于这种方式的其他优点，详见[零信任网络模型](../04%E5%AE%89%E5%85%A8/01零信任网络模型.md)。

除了我们目前提到的这些个玩意儿，边缘防火墙也可以用来限制外出连接，比如只允许对指定外部IP范围或服务的连接。但是边缘防火墙一般无法识别Pod，这些规则就会应用到集群中所有的Pod身上。这样提供了某种深层的防御，但是无法替代对网络策略的需求。

## NAT outgoing

网络地址转换（[NAT](https://en.wikipedia.org/wiki/Network_address_translation)）就是在数据包通过NAT设备时，将数据包中的一个IP地址映射成另一个IP。根据使用场景不同，NAT可以应用于源或目的IP地址，或者俩都闹。

在K8S的egress上下文中，如果Pod的IP地址无法在集群外路由，NAT就可以让这些Pod连接到集群外的服务（比如Pod网络是overlay的）。

比如，一个overlay网络中的Pod尝试连接一个集群外部的IP地址，Pod所在的主机就要用SNAT（源地址转换）将数据包中无法路由的源IP地址映射成节点自身的IP地址，然后再转发这个数据包。然后节点再将反方向返回的数据包映射回原来的Pod的IP地址，这样数据包就在两个方向上跑起来了，不管是Pod还是外部服务都感知不到映射的存在。

在大部分的集群中，NAT行为都是静态配置在整个集群上的。如果用Calico，可以使用[IP池](../06%E5%8F%82%E8%80%83/04资源定义/09IP池.md)针对特定地址范围，在更细的粒度上配置NAT行为。这样就让“无法路由”定义的更加紧密，而不仅仅是“集群内或集群外”，在一些企业部署场景中更加适用。

## 出口网关

另一种K8S的egress的方法是将所有的外出连接路由到一个或多个出口网关。网关对连接做SNAT（源地址转换），外部服务看到的连接就是从网关来的。主要的场景就是提高安全性，既可以在连接放行时扮演一个直接的安全角色，也可以和边缘防火墙（或其它外部实体）一起协同。比如，这样就可以让边缘防火墙看到连接时来自已知的IP地址（出口网关），而不是它不了解的动态Pod IP。

出口网关并不属于K8S的原生概念，但是一些K8S网络实现把它给搞出来了，以及一些服务网格。比如，Calico企业版就提供出口网关功能，还可以将命名空间（或单独的Pod）映射给指定的出口网关。边缘防火墙（或其它外部安全实体）继而就可以提供有效的基于命名空间的安全控制，即便它们看不到动态的Pod IP。

作为出口网关的替代方案，Calico允许你根据命名空间、节点、或者特定的Pod级别来控制Pod的IP地址范围。假设不需要outgoing NAT，这样就可以为边缘防火墙（或其它安全实体）提供一个非常简单的方式来集成K8S的入口和出口流量。（注意，这种方法需要有足够的可用地址空间，清晰的指定IP地址范围，比如为每个命名空间搞一个，在大规模部署的时候就有可能导致IP地址范围耗尽。此时选择出口网关可能会更好。）