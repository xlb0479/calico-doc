# eBPF

> 这里包含了一些相关的背景知识，不仅限于Calico。

eBPF是Linux内核的一个特性，允许将一些小程序快速且安全的加载到内核中，个性化其中的操作。

在这里你会学习到：

- eBPF的背景。
- eBPF的各种用法。
- Calico在eBPF数据面中是如何利用eBPF的。

## 什么是eBPF？

eBPF是嵌入到Linux内核中的一个虚拟机。它可以让小型程序加载到内核中，可以附加到钩子上，事件发生时就可以触发。这样就可以对内核的行为（有的时候是重度）个性化。虽然eBPF虚拟机对每种类型的钩子是一样的，但是钩子的能力可是相当多的。因为在内核中加载程序是非常危险的；内核都是通过一个非常严格的静态校验器来执行所有的程序；这个校验器将程序沙箱化了，保证它只能访问允许的内存，保证它必须会快速的结束。

## 为什么要叫eBPF？

eBPF指的是“extended Berkeley Packet Filter”。Berkeley Packet Filter是一个更早且更专业的虚拟机，专用于数据包过滤。像`tcpdump`这种工具就使用了“经典的”BPF虚拟机，选出应该被发往用户空间进行分析的数据包。eBPF是BPF的一个极大的扩展版本，广泛适用于内核场景中。虽然名字没什么变化，但eBPF能干的事儿可比数据包过滤要多得多。

## 它能干啥？

### eBPF程序的分类

内核中有几个典型的钩子，eBPF程序可以附加上去。eBPF程序的能力极大依赖于它所依附的钩子：

- **跟踪**程序可以附加到内核中的重要功能的一部分上。跟踪程序可以收集统计信息，可以深入到内核调试。*大部分*跟踪钩子都只允许对该功能所处理的数据进行只读访问，但也有一些是能修改的。Calico团队使用跟踪程序在开发阶段来调试Calico；比如研究为什么内核会突然丢了一个包。
- **流控**（`tc`）程序可以附加到一个网络设备的ingress和egress上。内核会对每一个数据包执行这个程序。因为这种钩子要处理数据包，内核允许这种程序修改或扩展数据包、丢弃数据包、标记排队，或者将数据包重定向到另一个接口上。Calico的eBPF数据面就是基于这种类型的钩子；我们使用tc程序对K8S的Service进行负载均衡，实现网络策略，并且，为已建立连接的流量创建一个快速通道。
- **XDP**，或者叫“eXpress Data Path”，实际上是eBPF一个钩子的名字。每个网络设备都有一个XDP ingress钩子，为每个进来的数据包在内核为其分配socket buffer之前触发一次。XDP可以在DoS防御（Calico的标准Linux数据面就支持）、ingress负载均衡（用于Facebook的Katran）场景中发挥出色的性能。XDP的问题在于要想获得性能提升，它需要网络设备驱动的支持。对于K8S的Pod网络需要的所有逻辑，XDP自己是无法全部满足的，但是通过XDP和流控钩子的结合是比较理想的。
- 把各种**socket**程序挂到各种socket操作上，例如可以允许eBPF程序修改一个新建的socket的目的IP，或者强制一个socket绑定到“正确的”源IP地址上。Calico使用这种程序实现K8S服务的连接时负载均衡；这样就减少了一部分压力，因为在数据包的处理路径上不需要[DNAT](02%E7%BD%91%E7%BB%9C.md)了。
- 有很多涉及安全的钩子，允许程序的行为以多种方式进行策略控制。比如**seccomp**钩子允许细粒度的策略控制系统调用。
- 还有……也许在你学习这个文档的同时又多了几个钩子；eBPF在内核中正处于快速发展阶段。

内核将每个钩子的能力通过“辅助函数”暴露出来。比如`tc`钩子就有一个辅助函数调整数据包的大小，但是在跟踪钩子中就没有这个辅助函数。使用eBPF的挑战之一就是不同的内核版本支持不同的辅助函数，缺少某个辅助函数就可能完全无法实现某个特性。

### BPF映射表

附加到eBPF钩子上的程序可以访问BPF“映射表”。BPF映射表有两个主要的使用场景：

- 允许BPF程序保存和读取长期数据。
- 允许BPF程序和用户空间程序进行通信。BPF程序可以读取用户空间写入的数据，反过来也行。

有很多种BPF映射表，包括一些特殊的类型，例如允许在程序间跳跃，或者是作为队列或栈来用，而不是严格的kv映射表。Calico使用映射表来跟踪活跃的连接，同时还用于配置BPF程序的策略和服务NAT信息。因为映射表的访问可能会非常低效，Calico的目标就是在一个已建立的连接上对每个数据包只做一次简单的映射表查询。

bpf映射表的内容可以用命令行工具`bpftool`来查看，这个工具内核自带。

## Calico的eBPF数据面

