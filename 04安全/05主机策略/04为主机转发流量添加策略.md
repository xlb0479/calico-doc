# 为转发流量设置策略

## 大面儿

为那些将主机作为路由器或者NAT网关，路过主机的流量设置Calico策略。

## 价值

如果主机有多个网卡，并且在不同网络之间作为路由器或NAT网关，那么可能需要为在两个网络之间经过的流量设置策略。此时，源和目的地可能都不是一个Calico端点，因此面向端点的策略就无法生效。这种主机你可以把防火墙策略也整合一下，使用跟Calico一样的策略语言。

## 特性

本文使用了Calico的以下特性：

- **HostEndpoint**
- **GlobalNetworkPolicy**
    - applyOnForward
    - preDNAT

## 概念

### 工作负载端点和主机端点

下图展示了一个双网络接口的主机：eth0和eth1。我们把这些网络接口称为**主机端点（HEP）**。这个主机上还运行着两个工作负载（VM或容器）。我们把工作负载的虚拟接口称为**工作负载端点（WEP）**。它们各自在Calico API中都有对应的配置对象，分别是HostEndpoint和WorkloadEndpoint。

`HostEndpoint API`是可选的，如果没有这个API对象，Calico不会为HEP设置任何策略。`WorkloadEndpoint API`对象是必需的，而且是由集群编排插件（例如Kubernetes或OpenStack）自动管理的。

图中包含了若干条连接，从1到4。比如1号连接通过HEP eth0进来，然后被转发，然后进入Workload A的WEP。Calico策略会选择它们对应的WEP或HEP。因此，假设一个ingress策略选中了Workload A的WEP，那么就会影响到1号连接。

![img](https://projectcalico.docs.tigera.io/images/host-forward-traffic.png)

### applyOnForward

默认情况下Calico的全局网络策略将**applyOnForward设置成false**。当策略选中HEP并且该值为false时，策略只会影响到从主机发起或到达主机的流量，例如：4号连接（Node进程）。1-3号连接不会受到HEP策略的影响，

相反，如果HEP策略的applyOnForward是true，那么这个策略会影响所有1-4号连接。例如：

- HEP eth0的ingress策略会影响1和2号连接
- HEP eth1的egress策略会影响2，3，4号连接

对于**applyOnForward: true**和**applyOnForward: false**策略，默认的动作语义也是不一样的。applyOnForward: true策略会影响所有流经HEP的流量（1-4号连接）。如果HEP对应的流向（ingress和egress）上没有applyOnForward策略，那么流量转发是正常放行的。相反，如果HEP对应的方向上没有策略（不管是不是applyOnForward），本地流量都会被拒绝。

|**有HEP？**|**流量类型**|**有applyOnForward？**|**有任意策略？**|**默认行为**
|-|-|-|-|-
|No|Any|n/a|n/a|Allow
|Yes|Forwarded|No|Any|Allow
|Yes|Forwarded|Yes|Yes|Deny
|Yes|Local|n/a|No|Deny
|Yes|Local|n/a|Yes|Deny