# 零信任网络模型

## 大面儿

使用零信任网络模型是对云原生策略中的工作负载与主机进行加固的最佳实践。

## 价值

零信任网络具备足够的弹性，即便是在攻击者尝试破坏应用或基础设置时。它让攻击者举步维艰，还能让行为观测变得更加轻松。

我们这里讲的更换控制模型，拥抱这些玩意儿的企业不用搞什么漫长的应用升级就可以牢牢地对网络进行加固。安全团队可以成为商业价值的驱动因素，而不是绊脚石。

## 特性

这里我们用到了Calico的以下特性：

- **NetworkPolicy**以及**GlobalNetworkPolicy**：
    - 命名空间
    - RBAC
    - Service Account
- **HostEndpoint**
- 集成AWS安全组
- 为Istio提供应用层策略

## 概念

### 网络总是充满敌意

**零信任网络**是一种网络安全手段，它表达的潜台词就是假设网络总是充满敌意的。这就跟边缘及“分区”手段，关注如何将可信区域跟不可信区域分割开来的思路完全相反。

为什么要假设网络的敌对性？在很多攻击场景中，的确是这样。

- 攻击者攻破了网络设施中的“可信”组件：路由器、交换机、链接，等等。
- 有意或无意的错误配置会导致敏感流量被路由到不可信的网络上，例如公共互联网。
- “可信”网络中的其它端点也会遭到攻击：你的应用可能跟其它数千个服务器、数万个容器、数千个个人电脑、手机等，共处同一个网络。

大部分攻击都是从一个很小的点渗入进来的，但是攻击者随后就可以通过网络悄悄地找到一些价值更高的目标：你的公司或客户的数据。在一个区域化或边缘化的模型中，攻击者一旦攻破一个点，就在区域和边缘内随意溜达。零信任网络面对这种威胁依然具备弹性，因为它在所有网络连接上都施加了严格的、密码加密的认证和访问控制。

### 零信任网络的必要条件

零信任网络要求网络的访问控制达到特定条件：

**条件1：**所有网络连接都要服从要求（不光是跨区域边界）
**条件2：**建立远程端点的身份必须总是要基于多重标准，包括强密码加密的身份凭证。特别是网络级的标识符，例如IP地址和端口，并不充分，因为在一个有敌意的网络中它可能会被假冒。
**条件3：**所有期望的和被允许的网络流量都要被明确的允许才行。没有被明确允许的连接都要被拒绝。
**条件4：**被攻击的工作负载无法绕过策略机制。
**条件5：**许多零信任网络还要求网络流量加密，防止敏感数据被有敌意的网络嗅探拆包。如果私有数据并没有在网络中交换的话，这就不是一个必要条件，但是为了满足零信任网络标准，如果要加密，那么所有网络连接都得加密，要搞全搞。零信任网络不会区分可信和不可信的网络链接或路径。而且，即便没有用加密手段保护数据，仍然会需要密码加密的真实性凭据来建立身份。

### Calico和Istio如何实现零信任网络的要求

Calico与Istio服务网格协同作战，在Kubernetes集群中实现了需要构建零信任网络的一切条件。

#### 多个施加点

使用Istio时，进入到工作负载的请求会穿过两个不同的施加点：

1. 主机Linux内核。Calico策略使用iptables在Linux内核的L3-L4层中施加策略。
2. Envoy代理。Calico在Envoy代理的L3-L7层中施加策略，对请求进行加密认证。在这种场景中，会有一个轻量级的策略决策Sidecar——Dikastes——来辅助Envoy。

这里的多个施加点根据多重标准（条件2）建立了远程端点的身份。主机Linux内核的施加点能够保护你的工作负载，即便工作负载的Pod被攻破且Envoy代理被绕过了（条件4）。

#### Calico策略存储

保存在Calico数据存储中的策略编制了流量白名单（条件3）。

Calico网络策略被设计用于灵活适配多种不同的安全范式，因此它能表达例如零信任网络的白名单模式，也能够表达以前的那种区域化的范式。你甚至可以同时把它们应用在不同的层级上，用不着搞一大堆策略文档管理也麻烦。

本文后面会介绍如何编写零信任网络风格专用的策略。理论上来说，你首先要默认拒绝所有网络流量，然后添加规则，只允许那些应用需要的流量。搞完之后，只有合法的应用流量才会被允许，其他的就都拒掉了。

#### Calico控制面

Calico控制面将策略信息从Calico数据存储中分发到每一个施加点上，确保所有网络连接都符合要求（条件1）。它将高层声明式策略翻译成具体的施加点的属性，并伴随应用扩缩以及开发者的更改而一同变化以满足要求。

#### Istio Citadel身份系统

在Calico和Istio中，工作负载的身份是基于Kubernetes的Service Account的。其中有一个Istio组件叫Citadel，负责给每个Service Account创建密码加密的密钥，用以在网络中标明身份（条件2）以及流量加密（条件5）。这样就可以在即便是攻击者攻破了路由器或链接这种网络设施之后，依然能够保证零信任网络的弹性。

## 怎么弄

现在我们讲一下如何用Calico和Istio建立零信任网络。我们站在平台和安全工程师的角度来进行讲解，但是对于开发者来说也同样有助于理解整个过程。

打造并维护一个零信任网络是整个应用交付团队的工作，也就是说为用户交付一个网络应用涉及到了每一个人。其中包括：

- 开发者、DevOps、运维
- 平台工程师
- 网络工程师
- 安全工程师以及安全操作员

特别是站在开发者的角度，把应用开发完了交给别人去研究如何加固，这就跟零信任网络策略穿不到一条裤子里。为了让一切良好运转，一个零信任网络需要根据详细的期望流量来配置——只有开发者清楚。

站在更高的角度来看，你应该按照以下步骤建立一个零信任网络：

1. 安装Calico。
2. 安装Istio并启用Calico集成。
3. 用ServiceAccount建立工作负载身份。
4. 给每个服务编写初始的白名单策略。

零信任网络建立之后，你需要对它进行维护。

### 安装Calico

按照[安装指引](../02%E5%AE%89%E8%A3%85Calico/01Kubernetes/00Kubernetes.md)进行安装。

### 安装Istio并启用Calico集成

参照[启用应用层策略](07Istio的策略/01%E4%B8%BAIstio%E6%96%BD%E5%8A%A0%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5.md)进行操作。

其中包括一个Istio安装的“demo”，可以进行快速验证。如果是生产环境部署零信任网络，应该按照Istio的官网文档进行安装。确保在安装选项中把**global.mtls.enabled**设置成了**true**，开启双向TLS（mTLS）认证。

### 用ServiceAccount建立工作负载身份

我们最终的目标是编写访问控制策略来为每一个期望的网络流量进行授权。我们希望这些流量紧切实际。在一个Calico的零信任网络中，加密身份就是Kubernetes的Service Account。Istio为你处理加密密钥的管理，这样每个工作负载就可以安全的坚持它的Service Account身份。