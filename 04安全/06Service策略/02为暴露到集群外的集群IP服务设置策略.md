# 为暴露到集群外的集群IP服务设置策略

## 大面儿

Service通过BGP将集群IP暴露到集群外部，对外部访问进行管控。

## 价值

Calico网络策略使用标准的Kubernetes Service，允许你将集群内的服务暴露给外部的客户端，方法如下：

- [为Kubernetes的节点端口设置策略](01%E4%B8%BAKubernetes%E7%9A%84%E8%8A%82%E7%82%B9%E7%AB%AF%E5%8F%A3%E8%AE%BE%E7%BD%AE%E7%AD%96%E7%95%A5.md)
- 使用基于BGP的集群IP（本文介绍）

## 特性

本文使用了Calico的以下特性：

- Calico集群IP发布
- **HostEndpoint**
- **GlobalNetworkPolicy**
    - applyOnForward
    - preDNAT
- **NetworkPolicy**

## 概念

### 将集群IP发布到集群外

一个**集群IP（clusterIP）**是一个虚拟的IP地址，用来代表一个Kubernetes Service。每个主机上的Kube Proxy将clusterIP翻译成服务后端某个Pod的IP，扮演了一个反向代理和负载均衡的角色。

集群IP起初是用于Kubernetes集群内的。Calico可以让你将集群IP发布到集群外部——这样外部的客户端就可以用它们来访问位于集群内的服务。这样就意味着Calico的ingress策略可以应用到以下**某个或全部**位置上：

- 主机接口，法网clusterIP的流量刚刚到达集群
- 后端Pod的接口

### 流量路由：本地与集群模式

Calico实现了[Kubernetes服务外部流量策略](https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/#preserving-the-client-source-ip)，它可以控制外部流量是路由到节点本地还是到集群范围内的端点上。下表总结出了这些设定之间的关键差异点。默认是**集群模式**。

|**Service设置**|**流量被负载均衡到……**|**优缺点**|**Service类型**
|-|-|-|-
|**externalTrafficPolicy: Cluster**（默认）|集群内的所有节点|为服务的所有Pod均匀分配流量。<br/><br/>外部流量进来之后可能会产生不必要的路由hop。当数据包被路由到另一个节点上时，流量会做SNAT（源地址转换）。<br/><br/>目标Pod看到的时代理节点的IP，而不是真实的客户端IP。|**ClusterIP**
|**externalTrafficPolicy: Local**|服务的端点所在的节点上|避免多余的hop，对于大流量的应用来说比较好<br/><br/>流量不会被SNAT，因此客户端的IP可以被保留下来。<br/><br/>服务内Pod之间的流量可能会不均衡。|**LoadBalancer**（云服务商），或**NodePort**（节点的静态端口）