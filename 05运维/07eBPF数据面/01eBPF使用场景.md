# eBPF使用场景

## 大面儿

了解什么时候能用（以及什么时候不能用）。

## 什么是eBPF？

eBPF是Linux内核中的一个特性，可以让你在内核中运行一个虚拟机。这个虚拟机可以让你安全地在内核中加载程序，并且定制程序。那么它为什么这么有用呢？

在老老年间，对内核进行修改是非常难的：有API可以用于获取数据，但是你不能干预内核中存在的东西或者进去执行代码。因此，你就得给Linux社区提交一个patch，等待它的通过。有了eBPF后，你可以将一个程序加载到内核中，然后比如当遇到某个特定的数据包或特定的事件发生时，命令内核执行你的程序。

有了eBPF，内核及其行为就变得高度可定制化了，而不是相对死板固定的模式。这一点及其有用，十年磨一剑，可以起到画龙点睛的作用。

## Calico和eBPF

Calico提供了eBPF数据面和标准的Linux数据面（基于iptables）。标准数据面关注的是兼容性，并且跟kube-proxy、iptables规则一同协作完成任务，而eBPF数据面关注的则是性能和延迟，以及相对于标准数据面带来的用户体验提升。

Calico不光支持标准Linux和eBPF；目前它一共支持三种数据面，包括了Windows HNS，并且计划在不久的将来引入更多的数据面。Calico可以让你选择出最适合你的模式。

如果你在Calico中启用eBPF时还留有其他的iptables规则，我们不会动它。比如你在使用连接时负载均衡的同时还想留着那些iptables。有了Calico，这就不会成为一锤子买卖——我们可以让你根据需要轻松地加载或卸载eBPF数据面，也就是说你可以在做决定前快速地先试一下。Calico可以让你按需加载eBPF，作为Kubernetes集群安全保障的又一利器。

## 使用场景

这里给出一些使用场景，包括流控、创建网络策略、连接时负载均衡。

### 流控

没有eBPF的话，数据包通过标准Linux网络路径一路到达目的地。如果一个数据包出现在A点，并且你知道它需要到达B点，你可以对这条网络路径进行优化，直接把它送到B点。有了eBPF，你可以利用额外的上下文在内核中完成这些修改，这样数据包可以绕过复杂的路由机制，直接到达目的地。

这在Kubernetes容器环境中是非常有用的，因为你的网络会非常多。（除了主机网络栈，每个容器有它自己的小网络栈。）当流量进来后，通常会路由到一个容器栈，然后必须经历一套复杂的路径，就跟它从主机网络栈过来时一样的套路。可以使用eBPF绕过这部分的路由。